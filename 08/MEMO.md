
# 第8章 バーチャルマシン#2：プログラム制御

## やったこと

* 中間コード（.vm）から アセンブリコード(.asm)への変換器をpythonで実装
    * 7章のものに加え、プログラムフローの制御や関数の定義・呼び出しなどを実装

## 実装手順

順に実装し、その都度テストを行う。
テストが通れば、その段階で実装してある部分は正しいと考えて良い（はず）ので、もし次の段階でテストがこけても修正箇所はある程度絞られる

1. まずはlabel,goto,if-gotoを実装
2. BasicLoop, FibonacciSeriesでテスト
3. function, returnを実装
    * 本書の図8-5を参考に実装
4. SimpleFunctionでテスト
5. callを実装
    * ブートストラップコードの生成もこの段階で実装
6. FibonacciElement, StaticsTestでテスト

## メモ

* 本書にも書いてあるとおり、指示されている順に実装してその都度テストしていかないとデバッグがかなりきつい
    * 順に実装してもデバッグきつかった
        * CPUエミュレータが不便…
* CodeWriterモジュールは、アセンブリコードの生成を関数化してどんどん抽象化していかなければコードの見通しがかなり悪くなってしまいそうである
    * 段階ごとにユニットテスト通ったらリファクタするようにして対応した
* 関数内で用いるラベルは、「(関数名$ラベル名)」という形式でasmに出力しなくてはいけないので、現在なんという名前の関数を変換しているのかを常に保持しておく必要がある
    * 関数が定義されていない（BasicLoop.vmのように、ただのコマンドの羅列であるファイルを変換している時などの）場合のラベルは「null$ラベル名」とした
* スタックってすごい